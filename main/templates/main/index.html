{% extends 'main/layout.html' %}
{% block style %}
th {
    margin: 0;
    padding: 0;
}
tr {
    margin: 0;
}
#new-note-form {
    margin-bottom: 2em;
}
{% endblock %}
{% block title %}Notes{% endblock %}
{% block body %}
    <section id="items-flex-container">
    {% if notes|length == 0 %}
    <p>No notes.</p>
    {% else %}
        {% for note in notes %}
        <a href="{% url 'view_note' note.id %}" class="item item-animate">
            <div class="item-shader hidden"></div>
            <div class="understand-bar {% if note.understand %}understand{% endif %}"></div>
            <h3>{{ note.title }}</h3>
        </a>
        {% endfor %}
        {% load layout_tags %}
        {% if request.user|has_permission:'main.add_note' %}
        <div class="item">
            <button class="item-add">+</button>
            <form action="{% url 'new_note' %}" class="new-item-form hidden">
                <div class="item-shader"></div>
                {% csrf_token %}
                <div class="form-item">
                    <p>Title: </p>
                    <div class="input-add-container">
                        {{ new_note_form.title }}
                        <button type="submit">Create</button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
    {% endif %}
    </section>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // querySelectorAll returns a NodeList therefore does not have slice() method built in 
        let items = Array.from(document.querySelectorAll('.item')).slice(0, -1);

        items.forEach(item => {
            item.addEventListener('mouseenter', function() {
                // initiate shader
                item.firstElementChild.classList.toggle('hidden')
            })
            item.addEventListener('mouseleave', function() {
                // deactivate shader
                item.firstElementChild.classList.toggle('hidden')
            })
        })


        // iteration would be the parts of the keyframe that are reached 
        // in this case, 0% and 100% are cause the iteration event listener to fire 
        // therefore we can track where in the animation process we are at by 
        // tracking the iteration event listener
        let iteration = 0;

        const itemAdd = document.querySelector('.item-add');
        function itemAddClicked() {
            itemAdd.style.animationPlayState = 'running';
            if (iteration % 2 != 0) {
                // animation going back to original state therefore hide form first
                itemAdd.parentElement.querySelector('form').classList.toggle('hidden')
            }
        }
        itemAdd.addEventListener('click', itemAddClicked)

        itemAdd.addEventListener('animationiteration', function() {
            itemAdd.style.animationPlayState = 'paused';
            iteration+=1;
            if (iteration % 2 == 0) {
                // original state, user may have exited therefore clear input and "reveal" shader so that the user cannot click on the inputs of the form
                itemAdd.parentElement.querySelector('form').firstElementChild.style.zIndex = 'initial';
                newNoteTitle.value = "";
            } else {
                // creation state, hide the shader (shader is always the first element in the form)
                itemAdd.parentElement.querySelector('form').firstElementChild.style.zIndex = -1;
                // after the button has reached creation iteration then reveal
                itemAdd.parentElement.querySelector('form').classList.toggle('hidden')
            }
        })

        const notesContainer = document.querySelector('#items-flex-container');
        const newNoteTitle = document.querySelector('#id_title');
        const newNoteButton = document.querySelector('.new-item-form button');

        function addNote(id, title, route) {
            try {
                const p = notesContainer.querySelector('p');
                notesContainer.removeChild(p)
            } catch(Exception) {
                // continue
            }

            const container = document.createElement('a'); 
            container.classList.add('item', 'item-animate')
            container.setAttribute('href', route)
            const shader = document.createElement('div');
            shader.classList.add('item-shader', 'hidden')
            const understandBar = document.createElement('div');
            understandBar.classList.add('understand-bar')
            const h3 = document.createElement('h3'); 
            h3.innerText = title;
            container.appendChild(shader)
            container.appendChild(understandBar)
            container.appendChild(h3)
            // notesContainer.appendChild(container)
            notesContainer.insertBefore(container, notesContainer.lastElementChild)
            newNoteTitle.value = "";

            // after adding, revert back to original stage in animation
            itemAddClicked()
        }

        document.querySelector('.new-item-form').addEventListener('submit', function(e) {
            e.preventDefault()
            newNoteButton.disabled = true;
            fetch(this.getAttribute('action'), {
                method: 'POST', 
                mode: 'same-origin',
                headers: new Headers({
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }), 
                body: JSON.stringify({
                    'title': newNoteTitle.value
                })
            })
            .then(async r => {
                const data = await r.json(); 
                if (r.status == 200) {
                    addNote(data.id, data.title, data.route)
                    newNoteButton.disabled = false;
                } else if (r.status == 400) {
                    for (const error_key in data.errors) {
                        const error = document.createElement('p');
                        error.innerText = data.errors[error_key];
                        const row = document.createElement('tr');
                        const th = document.createElement('th');
                        const td = document.createElement('td');
                        td.appendChild(error)
                        row.appendChild(th)
                        row.appendChild(td)
                        newNoteBody.appendChild(row)
                    }
                }
            })
            .catch(e => {console.log(e)})
        })

    })
</script>
{% endblock %}